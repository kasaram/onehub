create or replace TRIGGER insert_to_target AFTER UPDATE or INSERT on source FOR EACH ROW
DECLARE
--Cursors to feach data
CURSOR LastMonthTax is  select Amount_With_tax_monthly
                        from source 
                        where YYYYMM = :new.YYYYMM and Store_ID = :new.Store_ID;
                        
CURSOR Amount2_Without_Tax_Yearrly_C is  select sum(Amount_Without_tax_monthly)
                        from source 
                        where YYYYMM between :new.YYYYMM and add_months(trunc(:new.YYYYMM, 'month'), - 12) and Store_ID = :new.Store_ID;
                        
CURSOR Amount2_Tax_Yearrly_C is  select sum(Amount_tax_monthly)
                        from source 
                        where YYYYMM between :new.YYYYMM and add_months(trunc(:new.YYYYMM, 'month'), - 12) and Store_ID = :new.Store_ID;
--variables
LastMonthTaxVal LastMonthTax%ROWTYPE;
VarianceVal target.Variance%TYPE;
Amount2WithOutTaxYearly Amount2_Without_Tax_Yearrly_C%ROWTYPE;
Amount2TaxYearly Amount2_Tax_Yearrly_C%ROWTYPE;

BEGIN
OPEN LastMonthTax;
   FETCH LastMonthTax BULK COLLECT INTO LastMonthTaxVal;
CLOSE LastMonthTax;

OPEN Amount2_Without_Tax_Yearrly_C;
   FETCH Amount2_Without_Tax_Yearrly_C BULK COLLECT INTO Amount2WithOutTaxYearly;
CLOSE Amount2_Without_Tax_Yearrly_C;

OPEN Amount2_Tax_Yearrly_C;
   FETCH Amount2_Tax_Yearrly_C BULK COLLECT INTO Amount2TaxYearly;
CLOSE Amount2_Tax_Yearrly_C;

VarianceVal := LastMonthTaxVal;

--update target table
UPDATE target  
SET Last_month_tax = LastMonthTaxVal,  
    Variance = VarianceVal,
    Amount2_Without_Tax_Yearrly = Amount2WithOutTaxYearly,
    Amount2_tax_yearly = Amount2TaxYearly
WHERE YYYYMM = :new.YYYYMM and Store_ID = :new.Store_ID;

end;
/
